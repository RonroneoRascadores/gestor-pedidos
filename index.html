<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-md">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üçï Sistema de Pedidos</h1>
            <div id="connectionStatus" class="text-sm font-medium px-3 py-1 rounded-full inline-block">
                ‚öôÔ∏è Configurando...
            </div>
        </div>

        <!-- Configuration Section -->
        <div id="configSection" class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">‚öôÔ∏è Configuraci√≥n</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">URL del Google Apps Script:</label>
                <input type="url" id="scriptUrl" placeholder="https://script.google.com/macros/s/.../exec" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
            </div>
            
            <div class="flex gap-2">
                <button onclick="saveConfig()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                    üíæ Guardar y Conectar
                </button>
                <button onclick="clearAll()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                    üóëÔ∏è Limpiar Todo
                </button>
            </div>
            
            <div class="mt-4 space-y-2">
                <button onclick="syncData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                    üîÑ Sincronizar
                </button>
                
                <button onclick="testConnection()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                    üß™ Probar Conexi√≥n
                </button>
                
                <button onclick="testOrderSave()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2">
                    üî¨ Probar Guardado
                </button>
            </div>
        </div>

        <!-- Main App Section -->
        <div id="appSection" class="space-y-6">
            <!-- Action Buttons -->
            <div class="grid grid-cols-1 gap-3">
                <button onclick="showNewOrderForm()" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                    ‚ûï Nuevo Pedido
                </button>
                
                <button onclick="showProductsManager()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all duration-200 transform hover:scale-105">
                    üõ†Ô∏è Gestionar Productos
                </button>
            </div>

            <!-- Orders List -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">üìã Pedidos Recientes</h2>
                <div id="ordersList" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">No hay pedidos guardados</p>
                </div>
            </div>
        </div>

        <!-- New Order Modal -->
        <div id="newOrderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">üÜï Nuevo Pedido</h2>
                        <button onclick="closeNewOrderForm()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                    </div>

                    <form id="newOrderForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üë§ Nombre del Cliente:</label>
                            <input type="text" id="customerName" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>

                        <div>
                            <h3 class="text-lg font-medium text-gray-800 mb-3">üçï Productos:</h3>
                            <div id="productsSection" class="space-y-3">
                                <!-- Products will be loaded here -->
                            </div>
                        </div>

                        <div class="border-t pt-4">
                            <div class="flex justify-between items-center text-lg font-semibold">
                                <span>üí∞ Total:</span>
                                <span id="orderTotal">$0</span>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="button" onclick="closeNewOrderForm()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                Cancelar
                            </button>
                            <button type="submit" 
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                üíæ Guardar Pedido
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Manager Modal -->
        <div id="productsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800">üõ†Ô∏è Gestionar Productos</h2>
                        <button onclick="closeProductsManager()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                    </div>

                    <!-- Add Products Section -->
                    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-800 mb-3">‚ûï Agregar Productos</h3>
                        
                        <!-- Single Product Form -->
                        <form id="addProductForm" class="space-y-3 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del producto:</label>
                                <input type="text" id="newProductName" required placeholder="Ej: Pizza Napolitana"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                            </div>
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                ‚ûï Agregar Producto
                            </button>
                        </form>
                        
                        <!-- Bulk Import -->
                        <div class="border-t pt-4">
                            <h4 class="text-md font-medium text-gray-700 mb-2">üìã Importar Lista</h4>
                            <textarea id="bulkProductsText" placeholder="Pega tu lista aqu√≠, un producto por l√≠nea:&#10;Pizza Margarita&#10;Pizza Pepperoni&#10;Coca Cola&#10;Agua Mineral" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm h-24 resize-none"></textarea>
                            <button onclick="importBulkProducts()" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                                üì• Importar Lista
                            </button>
                        </div>
                    </div>

                    <!-- Products List -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-800 mb-3">üì¶ Productos Actuales</h3>
                        <div id="productsManagerList" class="space-y-2">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>

                    <div class="flex gap-3 pt-4 mt-6 border-t">
                        <button onclick="closeProductsManager()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clear Confirmation Modal -->
        <div id="clearModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
                <div class="p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ö†Ô∏è Confirmar Limpieza</h3>
                    <p class="text-gray-600 mb-4">¬øEst√°s seguro de que quieres eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.</p>
                    <p class="text-sm text-red-600 mb-4">Haz clic 3 veces en "Confirmar" y luego escribe "CONFIRMAR"</p>
                    
                    <div class="mb-4">
                        <button id="confirmButton" onclick="confirmClear()" 
                                class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 mb-2">
                            Confirmar (0/3)
                        </button>
                        <input type="text" id="confirmText" placeholder="Escribe CONFIRMAR" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-center hidden">
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="closeClearModal()" 
                                class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                            Cancelar
                        </button>
                        <button id="finalClearButton" onclick="performClear()" 
                                class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 hidden">
                            üóëÔ∏è Eliminar Todo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let orders = [];
        let products = {
            pizza_margarita: { name: 'Pizza Margarita', price: 0 },
            pizza_pepperoni: { name: 'Pizza Pepperoni', price: 0 },
            pizza_hawaiana: { name: 'Pizza Hawaiana', price: 0 },
            bebida_cola: { name: 'Coca Cola', price: 0 },
            bebida_agua: { name: 'Agua', price: 0 },
            postre_helado: { name: 'Helado', price: 0 }
        };
        let currentOrder = {};
        let confirmCount = 0;
        let scriptUrl = '';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadOrders();
            loadProducts();
            updateOrdersList();
            createProductsSection();
        });

        // Products management functions
        function loadProducts() {
            const savedProducts = localStorage.getItem('products');
            if (savedProducts) {
                products = JSON.parse(savedProducts);
            }
        }

        function saveProducts() {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function showProductsManager() {
            updateProductsManagerList();
            document.getElementById('productsModal').classList.remove('hidden');
            document.getElementById('productsModal').classList.add('flex');
        }

        function closeProductsManager() {
            document.getElementById('productsModal').classList.add('hidden');
            document.getElementById('productsModal').classList.remove('flex');
            // Refresh products section in new order form
            createProductsSection();
        }

        function updateProductsManagerList() {
            const container = document.getElementById('productsManagerList');
            
            if (Object.keys(products).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos</p>';
                return;
            }
            
            // Clear container first
            container.innerHTML = '';
            
            // Create elements properly with event listeners
            Object.entries(products).forEach(([key, product]) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                
                productDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${product.name}</div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="delete-btn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                
                // Add event listeners properly
                const editBtn = productDiv.querySelector('.edit-btn');
                const deleteBtn = productDiv.querySelector('.delete-btn');
                
                editBtn.addEventListener('click', () => editProduct(key));
                deleteBtn.addEventListener('click', () => deleteProduct(key));
                
                container.appendChild(productDiv);
            });
        }

        function editProduct(key) {
            const product = products[key];
            const newName = prompt('Nuevo nombre:', product.name);
            if (newName && newName.trim()) {
                products[key].name = newName.trim();
                saveProducts();
                updateProductsManagerList();
                createProductsSection(); // Refresh the order form too
                showMessage('‚úÖ Producto actualizado correctamente', 'success');
            }
        }

        function deleteProduct(key) {
            const product = products[key];
            if (confirm(`¬øEst√°s seguro de eliminar "${product.name}"?`)) {
                delete products[key];
                saveProducts();
                updateProductsManagerList();
                createProductsSection(); // Refresh the order form too
                showMessage('üóëÔ∏è Producto eliminado correctamente', 'success');
            }
        }

        // Add product form handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('addProductForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('newProductName').value.trim();
                
                if (!name) {
                    showMessage('Por favor ingresa el nombre del producto', 'error');
                    return;
                }
                
                // Generate unique key
                const key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now();
                
                products[key] = {
                    name: name,
                    price: 0 // Default price, not used in display
                };
                
                saveProducts();
                updateProductsManagerList();
                createProductsSection(); // Refresh the order form
                
                // Clear form
                document.getElementById('newProductName').value = '';
                
                showMessage('‚úÖ Producto agregado correctamente', 'success');
            });
        });

        // Bulk import function
        function importBulkProducts() {
            const text = document.getElementById('bulkProductsText').value.trim();
            if (!text) {
                showMessage('Por favor pega la lista de productos', 'error');
                return;
            }
            
            const lines = text.split('\n').filter(line => line.trim());
            let addedCount = 0;
            
            lines.forEach(line => {
                const name = line.trim();
                if (name) {
                    // Check if product already exists
                    const existingKey = Object.keys(products).find(key => 
                        products[key].name.toLowerCase() === name.toLowerCase()
                    );
                    
                    if (!existingKey) {
                        const key = name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now() + '_' + addedCount;
                        products[key] = {
                            name: name,
                            price: 0
                        };
                        addedCount++;
                    }
                }
            });
            
            if (addedCount > 0) {
                saveProducts();
                updateProductsManagerList();
                createProductsSection();
                document.getElementById('bulkProductsText').value = '';
                showMessage(`‚úÖ ${addedCount} productos agregados correctamente`, 'success');
            } else {
                showMessage('No se agregaron productos nuevos', 'info');
            }
        }

        // SUPER SIMPLE EXPORT - ALWAYS WORKS
        function exportOrderToPDF(order) {
            console.log('=== EXPORTANDO PEDIDO ===');
            
            const content = generatePDFContent(order);
            const fileName = `Pedido_${order.orderNumber}_${order.customerName.replace(/[^a-zA-Z0-9]/g, '_')}`;
            
            // Create a modal with the content for easy copying
            showExportModal(content, fileName, order.orderNumber);
        }
        
        // Show export modal with content
        function showExportModal(content, fileName, orderNumber) {
            // Remove existing modal if any
            const existingModal = document.getElementById('exportModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-800">üìÑ Pedido #${orderNumber}</h2>
                            <button onclick="closeExportModal()" class="text-gray-500 hover:text-gray-700 text-2xl">√ó</button>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="mb-4 space-y-2">
                            <button onclick="copyToClipboard()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                                üìã Copiar al Portapapeles
                            </button>
                            <button onclick="selectAllText()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                                ‚úÖ Seleccionar Todo el Texto
                            </button>
                            <button onclick="tryDirectDownload()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                                üíæ Intentar Descarga Directa
                            </button>
                        </div>
                        
                        <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm text-yellow-800">
                                <strong>üìù Instrucciones:</strong><br>
                                1. Haz clic en "üìã Copiar al Portapapeles"<br>
                                2. Abre el Bloc de Notas (Windows) o TextEdit (Mac)<br>
                                3. Pega el contenido (Ctrl+V o Cmd+V)<br>
                                4. Guarda como "${fileName}.txt"
                            </p>
                        </div>
                        
                        <div class="border rounded-lg">
                            <div class="bg-gray-50 px-3 py-2 border-b">
                                <span class="text-sm font-medium text-gray-700">Contenido del pedido:</span>
                            </div>
                            <textarea id="exportContent" readonly class="w-full h-64 p-3 font-mono text-sm resize-none border-0 focus:ring-0" style="font-family: 'Courier New', monospace;">${content}</textarea>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t bg-gray-50">
                        <button onclick="closeExportModal()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                            Cerrar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store content globally for functions
            window.exportContent = content;
            window.exportFileName = fileName;
            
            showMessage('üìÑ ¬°Ventana de exportaci√≥n abierta! Usa los botones para obtener tu pedido', 'success');
        }
        
        // Close export modal
        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // Copy to clipboard
        function copyToClipboard() {
            const textarea = document.getElementById('exportContent');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile
            
            try {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(window.exportContent).then(() => {
                        showMessage('‚úÖ ¬°Contenido copiado al portapapeles! Ahora p√©galo en un archivo de texto', 'success');
                    }).catch(() => {
                        // Fallback to execCommand
                        document.execCommand('copy');
                        showMessage('‚úÖ ¬°Contenido copiado! Ahora p√©galo en un archivo de texto', 'success');
                    });
                } else {
                    // Fallback to execCommand
                    document.execCommand('copy');
                    showMessage('‚úÖ ¬°Contenido copiado! Ahora p√©galo en un archivo de texto', 'success');
                }
            } catch (error) {
                console.error('Copy failed:', error);
                showMessage('‚ùå Error al copiar. Selecciona el texto manualmente y c√≥pialo con Ctrl+C', 'error');
            }
        }
        
        // Select all text
        function selectAllText() {
            const textarea = document.getElementById('exportContent');
            textarea.focus();
            textarea.select();
            textarea.setSelectionRange(0, 99999);
            showMessage('‚úÖ Texto seleccionado. Ahora c√≥pialo con Ctrl+C (o Cmd+C en Mac)', 'info');
        }
        
        // Try direct download (may not work in all environments)
        function tryDirectDownload() {
            try {
                const blob = new Blob([window.exportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.exportFileName + '.txt';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('üíæ Descarga iniciada. Si no funciona, usa el bot√≥n "Copiar al Portapapeles"', 'info');
            } catch (error) {
                console.error('Direct download failed:', error);
                showMessage('‚ùå Descarga directa no disponible. Usa "Copiar al Portapapeles"', 'warning');
            }
        }
        
        // Alternative text export
        function generatePDFContent(order) {
            const date = new Date(order.datetime);
            let content = `PEDIDO #${order.orderNumber}\n`;
            content += `================================\n\n`;
            content += `Cliente: ${order.customerName}\n`;
            content += `Fecha: ${date.toLocaleDateString()}\n`;
            content += `Hora: ${date.toLocaleTimeString()}\n\n`;
            content += `PRODUCTOS:\n`;
            content += `----------\n`;
            
            Object.entries(order.products || {}).forEach(([key, quantity]) => {
                if (quantity > 0) {
                    const productName = order.productNames[key] || 'Producto';
                    content += `${quantity}x ${productName}\n`;
                }
            });
            
            content += `\nTOTAL: ${order.total} items\n`;
            const status = order.status === 'completed' ? 'COMPLETADO' : 'PENDIENTE';
            content += `Estado: ${status}\n\n`;
            content += `Generado el ${new Date().toLocaleString()}`;
            
            return content;
        }
        
        // Download text file
        function downloadTextFile(content, filename) {
            console.log('üìÑ Downloading text file:', filename);
            try {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                console.log('‚úÖ Text file download completed');
            } catch (error) {
                console.error('‚ùå Text file download failed:', error);
                throw error;
            }
        }

        // Configuration functions
        function loadConfig() {
            const savedUrl = localStorage.getItem('scriptUrl');
            if (savedUrl) {
                scriptUrl = savedUrl;
                document.getElementById('scriptUrl').value = savedUrl;
                updateConnectionStatus('connected');
            } else {
                updateConnectionStatus('disconnected');
            }
        }

        function saveConfig() {
            const url = document.getElementById('scriptUrl').value.trim();
            if (!url) {
                showMessage('Por favor ingresa la URL del script', 'error');
                return;
            }
            
            if (!url.includes('script.google.com') || !url.endsWith('/exec')) {
                showMessage('URL inv√°lida. Debe ser de Google Apps Script y terminar en /exec', 'error');
                return;
            }
            
            scriptUrl = url;
            localStorage.setItem('scriptUrl', url);
            updateConnectionStatus('connected');
            showMessage('Configuraci√≥n guardada correctamente', 'success');
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            if (status === 'connected') {
                statusElement.textContent = '‚òÅÔ∏è Conectado';
                statusElement.className = 'text-sm font-medium px-3 py-1 rounded-full inline-block bg-green-100 text-green-800';
            } else {
                statusElement.textContent = '‚ùå Sin conexi√≥n';
                statusElement.className = 'text-sm font-medium px-3 py-1 rounded-full inline-block bg-red-100 text-red-800';
            }
        }

        // Test connection function
        async function testConnection() {
            if (!scriptUrl) {
                showMessage('Primero configura la URL del script', 'error');
                return;
            }

            showMessage('üß™ Probando conexi√≥n...', 'info');
            
            try {
                const testUrl = `${scriptUrl}?action=test&timestamp=${Date.now()}`;
                console.log('Testing URL:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    showMessage('‚úÖ Conexi√≥n exitosa! El script funciona correctamente', 'success');
                    updateConnectionStatus('connected');
                } else {
                    showMessage(`‚ùå Error del script: ${data.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Connection test error:', error);
                showMessage(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                updateConnectionStatus('disconnected');
            }
        }

        // Test order save function using GET
        async function testOrderSave() {
            if (!scriptUrl) {
                showMessage('Primero configura la URL del script', 'error');
                return;
            }

            showMessage('üî¨ Probando guardado de pedido...', 'info');
            
            const testOrder = {
                orderNumber: 6666,
                customerName: 'Cliente de Prueba GET',
                datetime: new Date().toISOString(),
                products: {
                    'pizza_margarita': 2,
                    'bebida_cola': 1
                },
                productNames: {
                    'pizza_margarita': 'Pizza Margarita',
                    'bebida_cola': 'Coca Cola'
                },
                total: 27,
                status: 'pending'
            };
            
            try {
                console.log('=== ENVIANDO PEDIDO DE PRUEBA CON GET ===');
                console.log('URL:', scriptUrl);
                console.log('Pedido:', JSON.stringify(testOrder, null, 2));
                
                // Convertir el pedido a par√°metros GET
                const params = new URLSearchParams({
                    action: 'saveOrder',
                    orderNumber: testOrder.orderNumber,
                    customerName: testOrder.customerName,
                    datetime: testOrder.datetime,
                    products: JSON.stringify(testOrder.products),
                    productNames: JSON.stringify(testOrder.productNames),
                    total: testOrder.total,
                    status: testOrder.status,
                    timestamp: Date.now()
                });
                
                const testUrl = `${scriptUrl}?${params.toString()}`;
                console.log('URL completa:', testUrl);
                
                const response = await fetch(testUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Response data:', JSON.stringify(result, null, 2));
                
                if (result.success) {
                    showMessage(`‚úÖ ¬°Pedido de prueba guardado exitosamente! Revisa tu Google Sheets - deber√≠a aparecer el pedido #${testOrder.orderNumber}`, 'success');
                } else {
                    showMessage(`‚ùå Error al guardar pedido de prueba: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Test order save error:', error);
                showMessage(`‚ùå Error al probar guardado: ${error.message}`, 'error');
            }
        }

        // Order functions
        function loadOrders() {
            const savedOrders = localStorage.getItem('orders');
            if (savedOrders) {
                orders = JSON.parse(savedOrders);
            }
        }

        function saveOrders() {
            localStorage.setItem('orders', JSON.stringify(orders));
        }

        function showNewOrderForm() {
            currentOrder = {
                products: {},
                productNames: {}
            };
            
            // Reset form
            document.getElementById('customerName').value = '';
            resetProductQuantities();
            updateOrderTotal();
            
            document.getElementById('newOrderModal').classList.remove('hidden');
            document.getElementById('newOrderModal').classList.add('flex');
        }

        function closeNewOrderForm() {
            document.getElementById('newOrderModal').classList.add('hidden');
            document.getElementById('newOrderModal').classList.remove('flex');
        }

        function createProductsSection() {
            const section = document.getElementById('productsSection');
            section.innerHTML = '';
            
            if (Object.keys(products).length === 0) {
                section.innerHTML = '<p class="text-gray-500 text-center py-4">No hay productos disponibles. Agrega productos primero.</p>';
                return;
            }
            
            Object.entries(products).forEach(([key, product]) => {
                const productDiv = document.createElement('div');
                productDiv.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                productDiv.innerHTML = `
                    <div class="flex-1">
                        <div class="font-medium text-gray-800">${product.name}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="updateQuantity('${key}', -1)" 
                                class="w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full flex items-center justify-center font-bold">-</button>
                        <span id="qty_${key}" class="w-8 text-center font-medium">0</span>
                        <button type="button" onclick="updateQuantity('${key}', 1)" 
                                class="w-8 h-8 bg-green-500 hover:bg-green-600 text-white rounded-full flex items-center justify-center font-bold">+</button>
                    </div>
                `;
                section.appendChild(productDiv);
            });
        }

        function resetProductQuantities() {
            Object.keys(products).forEach(key => {
                const qtyElement = document.getElementById(`qty_${key}`);
                if (qtyElement) {
                    qtyElement.textContent = '0';
                }
                currentOrder.products[key] = 0;
            });
        }

        function updateQuantity(productKey, change) {
            const currentQty = currentOrder.products[productKey] || 0;
            const newQty = Math.max(0, currentQty + change);
            
            currentOrder.products[productKey] = newQty;
            currentOrder.productNames[productKey] = products[productKey].name;
            
            const qtyElement = document.getElementById(`qty_${productKey}`);
            if (qtyElement) {
                qtyElement.textContent = newQty;
            }
            updateOrderTotal();
        }

        function updateOrderTotal() {
            let total = 0;
            Object.entries(currentOrder.products || {}).forEach(([key, quantity]) => {
                if (quantity > 0) {
                    total += quantity; // Just count quantities since no prices
                }
            });
            
            currentOrder.total = total;
            document.getElementById('orderTotal').textContent = `${total} items`;
        }

        // Form submission using GET
        document.getElementById('newOrderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                showMessage('Por favor ingresa el nombre del cliente', 'error');
                return;
            }
            
            // Check if any products selected
            const hasProducts = Object.values(currentOrder.products || {}).some(qty => qty > 0);
            if (!hasProducts) {
                showMessage('Por favor selecciona al menos un producto', 'error');
                return;
            }
            
            // Create order
            const order = {
                orderNumber: Date.now(),
                customerName: customerName,
                datetime: new Date().toISOString(),
                products: currentOrder.products,
                productNames: currentOrder.productNames,
                total: currentOrder.total,
                status: 'pending'
            };
            
            console.log('Creating order:', order);
            
            // Save locally
            orders.unshift(order);
            saveOrders();
            updateOrdersList();
            
            // Save to Google Sheets
            await saveOrderToSheet(order);
            
            closeNewOrderForm();
            showMessage(`‚úÖ Pedido #${order.orderNumber} guardado correctamente`, 'success');
        });

        async function saveOrderToSheet(order) {
            if (!scriptUrl) {
                showMessage('‚ö†Ô∏è No hay conexi√≥n configurada. Pedido guardado solo localmente.', 'warning');
                return;
            }
            
            try {
                console.log('=== GUARDANDO PEDIDO REAL CON GET ===');
                console.log('URL:', scriptUrl);
                console.log('Pedido:', JSON.stringify(order, null, 2));
                
                // Convertir el pedido a par√°metros GET
                const params = new URLSearchParams({
                    action: 'saveOrder',
                    orderNumber: order.orderNumber,
                    customerName: order.customerName,
                    datetime: order.datetime,
                    products: JSON.stringify(order.products),
                    productNames: JSON.stringify(order.productNames),
                    total: order.total,
                    status: order.status,
                    timestamp: Date.now()
                });
                
                const saveUrl = `${scriptUrl}?${params.toString()}`;
                console.log('URL de guardado:', saveUrl);
                
                const response = await fetch(saveUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('Response data:', JSON.stringify(result, null, 2));
                
                if (result.success) {
                    console.log('‚úÖ Order saved to Google Sheets successfully');
                    showMessage('‚úÖ Pedido guardado en Google Sheets', 'success');
                } else {
                    console.error('‚ùå Failed to save to Google Sheets:', result.error);
                    showMessage(`‚ö†Ô∏è Error al guardar en Google Sheets: ${result.error}`, 'warning');
                }
                
            } catch (error) {
                console.error('Error saving to sheet:', error);
                showMessage(`‚ö†Ô∏è Error de conexi√≥n: ${error.message}. Pedido guardado localmente.`, 'warning');
            }
        }

        function updateOrdersList() {
            const container = document.getElementById('ordersList');
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No hay pedidos guardados</p>';
                return;
            }
            
            container.innerHTML = orders.slice(0, 10).map(order => {
                const date = new Date(order.datetime);
                const productsList = Object.entries(order.products || {})
                    .filter(([key, qty]) => qty > 0)
                    .map(([key, qty]) => `${qty}x ${order.productNames[key] || 'Producto'}`)
                    .join(', ');
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 slide-up">
                        <div class="flex justify-between items-start mb-2">
                            <div class="font-semibold text-gray-800">#${order.orderNumber}</div>
                            <div class="text-sm text-gray-500">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                        </div>
                        <div class="text-gray-700 mb-1">üë§ ${order.customerName}</div>
                        <div class="text-sm text-gray-600 mb-2">üçï ${productsList}</div>
                        <div class="flex justify-between items-center">
                            <div class="font-semibold text-blue-600">üì¶ ${order.total} items</div>
                            <div class="flex gap-2 items-center">
                                <button onclick="exportOrderToPDF(orders.find(o => o.orderNumber === ${order.orderNumber}))" 
                                        class="text-xs px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded">
                                    üìÑ PDF
                                </button>
                                <div class="text-xs px-2 py-1 rounded-full ${order.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${order.status === 'completed' ? '‚úÖ Completado' : '‚è≥ Pendiente'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Sync function using GET
        async function syncData() {
            if (!scriptUrl) {
                showMessage('Primero configura la URL del script', 'error');
                return;
            }
            
            if (orders.length === 0) {
                showMessage('No hay pedidos para sincronizar', 'info');
                return;
            }
            
            try {
                showMessage('üîÑ Sincronizando datos...', 'info');
                
                const params = new URLSearchParams({
                    action: 'syncData',
                    orders: JSON.stringify(orders),
                    timestamp: Date.now()
                });
                
                const syncUrl = `${scriptUrl}?${params.toString()}`;
                
                const response = await fetch(syncUrl, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`‚úÖ Sincronizaci√≥n exitosa. ${result.ordersReceived || orders.length} pedidos procesados.`, 'success');
                } else {
                    showMessage(`‚ùå Error al sincronizar: ${result.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Sync error:', error);
                showMessage(`‚ùå Error al sincronizar: ${error.message}`, 'error');
            }
        }

        // Clear functions
        function clearAll() {
            confirmCount = 0;
            document.getElementById('confirmButton').textContent = 'Confirmar (0/3)';
            document.getElementById('confirmText').classList.add('hidden');
            document.getElementById('finalClearButton').classList.add('hidden');
            document.getElementById('clearModal').classList.remove('hidden');
            document.getElementById('clearModal').classList.add('flex');
        }

        function confirmClear() {
            confirmCount++;
            document.getElementById('confirmButton').textContent = `Confirmar (${confirmCount}/3)`;
            
            if (confirmCount >= 3) {
                document.getElementById('confirmText').classList.remove('hidden');
                document.getElementById('confirmButton').disabled = true;
                document.getElementById('confirmButton').classList.add('opacity-50');
                
                document.getElementById('confirmText').addEventListener('input', function(e) {
                    if (e.target.value === 'CONFIRMAR') {
                        document.getElementById('finalClearButton').classList.remove('hidden');
                    } else {
                        document.getElementById('finalClearButton').classList.add('hidden');
                    }
                });
            }
        }

        function performClear() {
            localStorage.clear();
            orders = [];
            products = {
                pizza_margarita: { name: 'Pizza Margarita', price: 0 },
                pizza_pepperoni: { name: 'Pizza Pepperoni', price: 0 },
                pizza_hawaiana: { name: 'Pizza Hawaiana', price: 0 },
                bebida_cola: { name: 'Coca Cola', price: 0 },
                bebida_agua: { name: 'Agua', price: 0 },
                postre_helado: { name: 'Helado', price: 0 }
            };
            scriptUrl = '';
            
            document.getElementById('scriptUrl').value = '';
            updateConnectionStatus('disconnected');
            updateOrdersList();
            createProductsSection();
            closeClearModal();
            
            showMessage('üóëÔ∏è Todos los datos han sido eliminados', 'success');
        }

        function closeClearModal() {
            document.getElementById('clearModal').classList.add('hidden');
            document.getElementById('clearModal').classList.remove('flex');
        }

        // Message system
        function showMessage(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-200',
                error: 'bg-red-100 text-red-800 border-red-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                info: 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 left-4 right-4 p-4 rounded-lg border-2 ${colors[type]} z-50 fade-in`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97ba3a9a83d7a12e',t:'MTc1NzI5MDI5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
